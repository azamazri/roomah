# DATABASE RESET & MIGRATION GUIDE

## ⚠️ IMPORTANT: Read Before Proceeding

**Tujuan:** Reset database Supabase untuk menghapus schema lama dan menerapkan Phase 2 design yang baru.

**Dampak:**
- ✅ Menghapus SEMUA table, function, trigger, RLS policies lama
- ✅ Menghapus SEMUA data yang ada (jika ada)
- ✅ Memberikan clean slate untuk Phase 2 implementation
- ✅ Mencegah conflict antara schema lama dan baru

**Prasyarat:**
- Pastikan tidak ada data production yang penting (masih development)
- Backup data jika diperlukan (optional)
- Akses ke Supabase Dashboard dengan project fvqcwphjgftadhbqkpss

---

## 🔄 PROCEDURE: Database Reset & Migration

### STEP 0: Pre-Reset Checklist

**Check current database state:**

```sql
-- Check existing tables
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;

-- Check existing enums
SELECT typname 
FROM pg_type 
WHERE typnamespace = 'public'::regnamespace 
  AND typtype = 'e'
ORDER BY typname;

-- Check existing functions
SELECT proname 
FROM pg_proc p 
JOIN pg_namespace n ON p.pronamespace = n.oid 
WHERE n.nspname = 'public'
ORDER BY proname;
```

**Optional: Backup existing data (if needed)**
```bash
# Via Supabase Dashboard: 
# Settings → Database → Backups → Download Backup

# Or via pg_dump (if you have direct access):
pg_dump "postgresql://postgres:YOUR_PASSWORD@db.fvqcwphjgftadhbqkpss.supabase.co:5432/postgres" > backup_$(date +%Y%m%d).sql
```

---

### STEP 1: Reset Database (Clean Slate)

1. **Go to Supabase SQL Editor:**
   https://supabase.com/dashboard/project/fvqcwphjgftadhbqkpss/sql/new

2. **Copy entire content from:**
   ```
   supabase/migrations/00_RESET_DATABASE.sql
   ```

3. **Paste into SQL Editor**

4. **Click "Run" (or press Ctrl+Enter)**

5. **Wait for completion** (should take 5-10 seconds)

6. **Verify reset successful:**
   ```sql
   -- Should return empty (or only system tables)
   SELECT table_name 
   FROM information_schema.tables 
   WHERE table_schema = 'public';
   
   -- Should return empty
   SELECT typname 
   FROM pg_type 
   WHERE typnamespace = 'public'::regnamespace 
     AND typtype = 'e';
   ```

**Expected Output:**
```
✅ Query executed successfully (no errors)
✅ Tables list: empty
✅ Enums list: empty
✅ Database is now clean
```

---

### STEP 2: Run Phase 2 Migrations

**Run migrations in this EXACT order:**

#### 2.1 Create Enums
```sql
-- File: 20250116_01_create_enums.sql
-- Copy from: supabase/migrations/20250116_01_create_enums.sql
-- Paste into SQL Editor → Run
```

**Verify:**
```sql
SELECT typname FROM pg_type 
WHERE typnamespace = 'public'::regnamespace 
  AND typtype = 'e'
ORDER BY typname;

-- Expected: 9 enums created:
-- cv_status_enum
-- education_enum
-- gender_enum
-- income_bracket_enum
-- ledger_reason
-- ledger_type
-- payment_status
-- taaruf_request_status
-- taaruf_session_status
```

---

#### 2.2 Create Core Tables
```sql
-- File: 20250116_02_create_core_tables.sql
-- Copy from: supabase/migrations/20250116_02_create_core_tables.sql
-- Paste into SQL Editor → Run
```

**Verify:**
```sql
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;

-- Expected tables:
-- onboarding_verifications
-- profiles
-- provinces
-- sequences
```

**Check sequences initialized:**
```sql
SELECT * FROM public.sequences;

-- Expected:
-- CANDIDATE_IKHWAN | 0
-- CANDIDATE_AKHWAT | 0
-- TAARUF           | 0
```

---

#### 2.3 Create CV Tables
```sql
-- File: 20250116_03_create_cv_tables.sql
-- Copy from: supabase/migrations/20250116_03_create_cv_tables.sql
-- Paste into SQL Editor → Run
```

**Verify:**
```sql
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' AND table_name LIKE 'cv%'
ORDER BY table_name;

-- Expected:
-- cv_data
-- cv_details
```

---

#### 2.4 Create Remaining Tables

**You need to create these migration files next:**

```
⏳ 20250116_04_create_taaruf_tables.sql
⏳ 20250116_05_create_wallet_tables.sql
⏳ 20250116_06_create_audit_tables.sql
```

**Template for taaruf tables (04):**

```sql
-- =====================================================
-- Migration: 04 - Create Taaruf Tables
-- =====================================================

CREATE TABLE public.taaruf_requests (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  from_user uuid NOT NULL REFERENCES public.profiles(user_id) ON DELETE CASCADE,
  to_user uuid NOT NULL REFERENCES public.profiles(user_id) ON DELETE CASCADE,
  status public.taaruf_request_status NOT NULL DEFAULT 'PENDING',
  reason_reject text,
  created_at timestamptz DEFAULT now(),
  decided_at timestamptz,
  expires_at timestamptz DEFAULT (now() + INTERVAL '7 days'),
  
  UNIQUE(from_user, to_user),
  CHECK (from_user != to_user)
);

COMMENT ON TABLE public.taaruf_requests IS 'Ta''aruf proposals with 7-day expiration';

CREATE TABLE public.taaruf_sessions (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_a uuid NOT NULL REFERENCES public.profiles(user_id) ON DELETE CASCADE,
  user_b uuid NOT NULL REFERENCES public.profiles(user_id) ON DELETE CASCADE,
  status public.taaruf_session_status NOT NULL DEFAULT 'ACTIVE',
  taaruf_code text UNIQUE NOT NULL,
  started_at timestamptz DEFAULT now(),
  ended_at timestamptz,
  
  CHECK (user_a != user_b)
);

COMMENT ON TABLE public.taaruf_sessions IS 'Active ta''aruf sessions - only one active per user';
```

**Template for wallet tables (05):**

```sql
-- =====================================================
-- Migration: 05 - Create Wallet Tables
-- =====================================================

CREATE TABLE public.koin_topup_orders (
  order_id text PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES public.profiles(user_id) ON DELETE CASCADE,
  amount_cents int NOT NULL CHECK (amount_cents > 0),
  payment_type text,
  status public.payment_status NOT NULL DEFAULT 'PENDING',
  snap_token text,
  raw_midtrans jsonb,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  settled_at timestamptz
);

COMMENT ON TABLE public.koin_topup_orders IS 'Midtrans payment orders';

CREATE TABLE public.wallet_ledger_entries (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES public.profiles(user_id) ON DELETE CASCADE,
  type public.ledger_type NOT NULL,
  amount_cents int NOT NULL CHECK (amount_cents > 0),
  reason public.ledger_reason NOT NULL,
  linked_order_id text REFERENCES public.koin_topup_orders(order_id) ON DELETE SET NULL,
  idempotency_key text NOT NULL UNIQUE,
  created_at timestamptz DEFAULT now()
);

COMMENT ON TABLE public.wallet_ledger_entries IS 'Ledger-first transaction log';
```

**Template for audit table (06):**

```sql
-- =====================================================
-- Migration: 06 - Create Audit Tables
-- =====================================================

CREATE TABLE public.admin_actions_audit (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  admin_id uuid NOT NULL REFERENCES public.profiles(user_id) ON DELETE SET NULL,
  action text NOT NULL,
  target_table text,
  target_id text,
  details jsonb,
  correlation_id text,
  created_at timestamptz DEFAULT now()
);

COMMENT ON TABLE public.admin_actions_audit IS 'Admin action audit trail - permanent retention';
```

---

### STEP 3: Verify Core Schema Created

After running migrations 01-06:

```sql
-- Check all tables
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;

-- Expected 11 tables:
-- ✅ admin_actions_audit
-- ✅ cv_data
-- ✅ cv_details
-- ✅ koin_topup_orders
-- ✅ onboarding_verifications
-- ✅ profiles
-- ✅ provinces
-- ✅ sequences
-- ✅ taaruf_requests
-- ✅ taaruf_sessions
-- ✅ wallet_ledger_entries

-- Check foreign keys working
SELECT 
  tc.table_name, 
  kcu.column_name, 
  ccu.table_name AS foreign_table_name
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY' 
  AND tc.table_schema = 'public'
ORDER BY tc.table_name;

-- Should show all FK relationships correctly
```

---

### STEP 4: Continue with Remaining Migrations

**Still need to create and run:**

```
07. 20250116_07_create_indexes.sql        (38 indexes)
08. 20250116_08_create_functions.sql      (7 functions + 5 triggers)
09. 20250116_09_create_views.sql          (MV + balance view)
10. 20250116_10_seed_provinces.sql        (38 provinsi)
11. 20250116_11_enable_rls.sql            (Enable RLS)
12. 20250116_12_create_helper_functions.sql (RLS helpers)
13-17. RLS policies per feature
18. 20250116_18_test_rls.sql              (Test suite)
```

**All SQL templates available in:**
- `docs/phase1-persiapan/01-DATABASE-SCHEMA-DESIGN.md`
- `docs/phase1-persiapan/02-RLS-POLICIES-DESIGN.md`
- `docs/phase1-persiapan/03-08-COMPREHENSIVE-DESIGN.md`

---

## ✅ Success Criteria

After completing all migrations, verify:

```sql
-- 1. All 14 tables created
SELECT COUNT(*) FROM information_schema.tables 
WHERE table_schema = 'public';
-- Expected: 14 (11 base + 1 MV + 2 internal)

-- 2. All indexes created
SELECT COUNT(*) FROM pg_indexes 
WHERE schemaname = 'public';
-- Expected: ~40+ indexes

-- 3. RLS enabled on all tables
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public';
-- Expected: All tables show rowsecurity = true

-- 4. Provinces seeded
SELECT COUNT(*) FROM public.provinces;
-- Expected: 38 rows

-- 5. Materialized view exists
SELECT matviewname FROM pg_matviews 
WHERE schemaname = 'public';
-- Expected: approved_candidates_v

-- 6. Functions created
SELECT COUNT(*) FROM pg_proc p 
JOIN pg_namespace n ON p.pronamespace = n.oid 
WHERE n.nspname = 'public';
-- Expected: ~10+ functions
```

---

## 🆘 Troubleshooting

### Error: "relation does not exist"
**Cause:** Running migrations out of order (FK references missing table)
**Fix:** Run migrations 01-06 in EXACT order

### Error: "type already exists"
**Cause:** Reset script didn't complete fully
**Fix:** Run reset script again, check for errors

### Error: "permission denied"
**Cause:** Not using service_role or admin account
**Fix:** Use Supabase Dashboard SQL Editor (has full permissions)

### Error: "column does not exist"
**Cause:** Schema mismatch between old and new design
**Fix:** This confirms reset is needed! Run reset script.

---

## 📋 Quick Checklist

**Before Reset:**
- [ ] Backup any important data (if exists)
- [ ] Confirm project ID: fvqcwphjgftadhbqkpss
- [ ] Open Supabase SQL Editor in browser

**During Reset:**
- [ ] Run `00_RESET_DATABASE.sql` → Success
- [ ] Verify tables empty → Confirmed
- [ ] Verify enums dropped → Confirmed

**After Reset (Phase 2 Migrations):**
- [ ] Run migration 01 (enums) → 9 enums created
- [ ] Run migration 02 (core tables) → 4 tables created
- [ ] Run migration 03 (CV tables) → 2 tables created
- [ ] Create & run migration 04 (taaruf tables) → 2 tables
- [ ] Create & run migration 05 (wallet tables) → 2 tables
- [ ] Create & run migration 06 (audit table) → 1 table
- [ ] Continue with migrations 07-18...

**Final Verification:**
- [ ] All 14 tables exist
- [ ] All indexes created
- [ ] RLS enabled
- [ ] Provinces seeded
- [ ] MV created
- [ ] Functions & triggers working

---

## 🚀 Next Steps After Successful Migration

Once database is ready:

1. **Create Supabase utility files:**
   - `lib/supabase/server.ts`
   - `lib/supabase/service.ts`
   - `lib/supabase/client.ts`

2. **Implement Server Actions:**
   - Auth (register, login, onboarding)
   - CV (CRUD operations)
   - Candidates (browse, ajukan taaruf)
   - Taaruf (accept/reject, finish)
   - Payments (create order, webhook)
   - Admin (approve CV)

3. **Setup integrations:**
   - Midtrans SDK
   - Sentry error tracking
   - Rate limiting (optional)

4. **Write tests:**
   - Unit tests
   - Integration tests
   - E2E tests

---

**Ready to start? Follow the steps above and report back any issues!** 🚀
